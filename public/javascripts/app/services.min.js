"use strict";var app=angular.module("app.services",["ui.bootstrap","dialogs","i18n","ngCookies"]);app.factory("$store",["$parse","$cookieStore",function(e,t){var s="undefined"==typeof window.localStorage?void 0:window.localStorage,n=!("undefined"==typeof s||"undefined"==typeof window.JSON),r={parseValue:function(e){var t;try{t=JSON.parse(e),"undefined"==typeof t&&(t=e),"true"==t&&(t=!0),"false"==t&&(t=!1),parseFloat(t)!=t||angular.isObject(t)||(t=parseFloat(t))}catch(s){t=e}return t}},a={set:function(e,a){if(!n)try{return t.set(e,a),a}catch(o){console.log("Local Storage not supported, make sure you have the $cookieStore supported.")}var i=JSON.stringify(a);return s.setItem(e,i),r.parseValue(i)},get:function(e){if(!n)try{return r.parseValue(t.get(e))}catch(a){return null}var o=s.getItem(e);return r.parseValue(o)},remove:function(e){if(!n)try{return t.remove(e),!0}catch(r){return!1}return s.removeItem(e),!0},bind:function(t,s,n){return n=n||"",a.get(s)||a.set(s,n),e(s).assign(t,a.get(s)),t.$watch(s,function(e){a.set(s,e)},!0),a.get(s)}};return a}]),app.factory("$authenticator",["$rootScope","$store",function(e,t){return e.userDetails={},{userDetails:function(){return e.userDetails=JSON.parse(t.get("userDetails")),e.userDetails},loginSuccessfully:function(s){e.userDetails=s,t.set("userDetails",JSON.stringify(e.userDetails))},updateUserDetails:function(){t.set("userDetails",JSON.stringify(e.userDetails))},logoutSuccessfully:function(){this.userIsAuthenticated=!1,t.remove("userDetails"),t.remove("userIsAuthenticated")}}}]),app.factory("$messages",["$rootScope",function(e){return{type:"",message:"",addMessage:function(e,t){this.type=e,this.message=t,this.broadcastMessage()},addErrorMessage:function(e){this.type="danger",this.message=e,this.broadcastMessage()},addInfoMessage:function(e){this.type="info",this.message=e,this.broadcastMessage()},addWarningMessage:function(e){this.type="warning",this.message=e,this.broadcastMessage()},addSuccessMessage:function(e){this.type="success",this.message=e,this.broadcastMessage()},cleanAllMessages:function(){this.broadcastCleanMessages()},broadcastMessage:function(){e.$broadcast("messageBroadcast")},broadcastCleanMessages:function(){e.$broadcast("cleanMessagesBroadcast")}}}]),app.factory("AppManager",["$rootScope","$http","$authenticator","$messages","$dialogs","$timeout","i18n","$store",function(e,t,s,n,r,a,o,i){e.onlyNumbers=/^\d+$/,e.showing=!1,e.form={},e.name="",e.listUrl="",e.predicate="",e.reverse=!0,e.item={},e.items=[],e.history=[],e.historyItems=[],e.historyVersion=null,e.saveType="",e.selectedTab=0;var c=function(){};e.newItem=c,e.focus=c,e.hotkeys=c,e.listFilter=function(e){return e.filter.status?"/status/"+e.filter.status:""},e.listBefore=c,e.listAfter=c,e.validate=c,e.createBefore=c,e.createAfter=c,e.findBefore=c,e.findAfter=c,e.saveBefore=c,e.saveAfter=c,e.cancelBefore=c,e.cancelAfter=c,e.removeBefore=function(e,t){t()},e.removeAfter=c,e.loadArrays=[],e.errorHandler={},e.filter={status:""};var u=function(t){e.name=t.name,e.listUrl=t.listUrl?t.listUrl:"/"+t.name+"s",t.predicate&&(e.predicate=t.predicate),t.focus&&(e.focus=function(){$("#"+t.name+"-"+t.focus).focus()}),angular.isFunction(t.hotkeys)&&(e.hotkeys=t.hotkeys),t.list&&(angular.isFunction(t.list.filter)&&(e.listFilter=t.list.filter),angular.isFunction(t.list.before)&&(e.listBefore=t.list.before),angular.isFunction(t.list.after)&&(e.listAfter=t.list.after)),t.actions&&(angular.isFunction(t.actions.newItem)&&(e.newItem=t.actions.newItem),angular.isFunction(t.actions.focus)&&(e.focus=t.actions.focus),angular.isFunction(t.actions.validate)&&(e.validate=t.actions.validate),angular.isFunction(t.actions.createBefore)&&(e.createBefore=t.actions.createBefore),angular.isFunction(t.actions.createAfter)&&(e.createAfter=t.actions.createAfter),angular.isFunction(t.actions.findBefore)&&(e.findBefore=t.actions.findBefore),angular.isFunction(t.actions.findAfter)&&(e.findAfter=t.actions.findAfter),angular.isFunction(t.actions.saveBefore)&&(e.saveBefore=t.actions.saveBefore),angular.isFunction(t.actions.saveAfter)&&(e.saveAfter=t.actions.saveAfter),angular.isFunction(t.actions.removeBefore)&&(e.removeBefore=t.actions.removeBefore),angular.isFunction(t.actions.removeAfter)&&(e.removeAfter=t.actions.removeAfter),angular.isFunction(t.actions.cancelBefore)&&(e.cancelBefore=t.actions.cancelBefore),angular.isFunction(t.actions.cancelAfter)&&(e.cancelAfter=t.actions.cancelAfter)),t.load&&t.load.arrays&&(e.loadArrays=t.load.arrays),t.error&&angular.isFunction(t.error.handle)&&(e.errorHandler=t.error.handle)},l={$rootScope:e,$store:i};e.currentPage=0,e.pageSize=1,e.historyCurrentPage=0,e.historyPageSize=1,e.prevPage=function(t){n.cleanAllMessages(),t?e.historyCurrentPage>0&&(e.historyCurrentPage--,e.historyList(e.historyCurrentPage),e.historyVersion=null):e.currentPage>0&&(e.currentPage--,e.list(e.currentPage))},e.nextPage=function(t){n.cleanAllMessages(),t?e.historyCurrentPage<e.historyPageSize-1&&(e.historyCurrentPage++,e.historyList(e.historyCurrentPage+1),e.historyVersion=null):e.currentPage<e.pageSize-1&&(e.currentPage++,e.list(e.currentPage+1))},e.setPage=function(t){t?(n.cleanAllMessages(),e.historyCurrentPage=this.n,e.historyList(e.historyCurrentPage+1),e.historyVersion=null):(n.cleanAllMessages(),e.currentPage=this.n,e.list(e.currentPage+1))},e.range=function(e,t){var s=[];t||(t=e,e=0);for(var n=e;t>n;n++)s.push(n);return s};var f=function(t,s,r,a,o){angular.isFunction(e.errorHandler)?e.errorHandler({operation:t,data:s,status:r,header:a,config:o,messages:n}):n.addErrorMessage("An error occurred in the execution.")};e.create=function(){e.createBefore(l),e.item=e.newItem(l),e.showing=!0,g(),a(function(){e.focus()},100),e.createAfter(l)};var g=function(){e.history=[],e.historyItems=[],e.historyVersion=null};e.cancel=function(){e.cancelBefore(l),e.item=e.newItem(l),e.showing=!1,g(),e.cancelAfter(l)},e.historyCopy=function(){var t=angular.isObject(e.historyVersion);if(e.form.historySelected.$setValidity("historyNotSelected",t),t){var s=e.item.version;e.item=e.historyVersion,s&&(e.item.version=s)}},e.list=function(s){s||(s=1,e.currentPage=0),e.listBefore(l);var n=e.listFilter({filter:e.filter});n+="/page/"+s,t.get(vulpe.ng.rootContext+e.listUrl+n).success(function(t){e.items=t.items,e.pageSize=t.pageCount,e.listAfter(l)})},e.historyList=function(s){g(),s||(s=1),t.get(vulpe.ng.rootContext+e.name+"/history/"+e.item._id+"/page/"+s).success(function(t){e.history=t.items,0!==e.history.length&&(e.historyPageSize=t.pageCount,angular.forEach(e.history,function(t){e.historyItems.push(JSON.parse(t.content))}))})},e.find=function(s){e.findBefore(l),t.get(vulpe.ng.rootContext+"/"+e.name+"/"+s).success(function(t){e.item=t.item,e.showing=!e.showing,e.history=t.history.items,0!==e.history.length&&(e.historyPageSize=t.history.pageCount,angular.forEach(e.history,function(t){e.historyItems.push(JSON.parse(t.content))})),e.findAfter(l),a(function(){e.focus()},100)})},e.remove=function(s){var a=function(){n.cleanAllMessages(),e.removeBefore(s,function(){t({method:"DELETE",url:"/"+e.name+"/"+s}).success(function(){e.list(),n.addSuccessMessage("Operation successfully executed!"),e.removeAfter(l)}).error(function(e,t,s,n){f("REMOVE",e,t,s,n)})})};r.confirm(o.__("Confirmation"),o.__("Do you really want to delete?")).result.then(function(){a()},function(){})},e.removeFromArray=function(t,s,a){var i=e.$eval("item."+t),c=function(){n.cleanAllMessages(),i.splice(a,1)},u=e.$eval("item."+t+"["+a+"]."+s);u?r.confirm(o.__("Confirmation"),o.__("Do you really want to delete?")).result.then(function(){c()},function(){}):c()},e.addToArray=function(t,s){n.cleanAllMessages();var r=e.$eval("item."+t);r.push(s)};return e.save=function(r){if(e.form.$valid)if(r)e.saveType=r;else{e.saveBefore(l),n.cleanAllMessages();var o=s.userDetails();e.item.user=o.id,t.post(vulpe.ng.rootContext+"/"+e.name,e.item).success(function(t){e.item=t.item,e.saveType.length>0&&("NEW"===e.saveType?e.create():"CLOSE"===e.saveType&&(e.create(),e.showing=!1),e.saveType=""),n.addSuccessMessage("Operation successfully executed!"),a(function(){e.list(),e.focus()},100),e.saveAfter(l)}).error(function(e,t,s,n){f("SAVE",e,t,s,n)})}},e.status=function(s,r){n.cleanAllMessages(),t.post(vulpe.ng.rootContext+"/"+e.name+"/status",{id:s,status:r}).success(function(){n.addSuccessMessage("Status successfully changed!"),a(function(){e.list(e.currentPage+1),e.focus()},100)}).error(function(e,t,s,n){f("STATUS",e,t,s,n)})},e.datepicker=function(t){t.preventDefault(),t.stopPropagation(),e.datepickerOpened=!e.datepickerOpened},e.inputFocus=function(e){var t="input[name='"+e+"']",s=$(t).filter(function(){return""==this.value});s.length>0?$(s.get(0)).focus():$(t).focus()},e.nextTab=function(){e.showing&&$($("li.ng-isolate-scope").get(e.selectedTab+1)).find("a").trigger("click")},e.previousTab=function(){e.showing&&$($("li.ng-isolate-scope").get(e.selectedTab-1)).find("a").trigger("click")},e.tabsHotkeys=function(){$(document).bind("keydown.left",function(){return e.previousTab(),!1}).bind("keydown.right",function(){return e.nextTab(),!1})},e.focusTo=function(e){$(0!==e.indexOf("#")?"#"+e:e).focus()},e.checkUncheckAll=function(t){e.selectAll=!e.selectAll,angular.forEach(e[t],function(t){t.selected=e.selectAll})},e.hasRoles=function(e){for(var t=s.userDetails(),n=0;n<e.length;n++){var r=e[n];if(t.managerType===r)return!0}return!1},e.equals=function(e,t,s){return e?e[t]===s:!1},e.load=function(s,n,r){e[n]=[],t.get(s).success(function(t){e[n]=t.items,r&&angular.forEach(e[n],function(e){e.label="";var t=[],s=" - ";angular.isArray(r)?t=r:angular.isObject(r)&&(t=r.properties,s=r.separator),t.forEach(function(t){e.label.length>0&&(e.label+=s),e.label+=e[t]})})})},u.prototype.init=function(){s.userDetails(),e.item=e.newItem(l),e.validate(),e.list(),angular.forEach(e.loadArrays,function(t){e.load(t.from,t.name,t.label||!1)}),e.hotkeys(),e.tabsHotkeys(),e.focus()},u}]);
"use strict";var app=angular.module("app.services",["ui.bootstrap","dialogs","i18n","ngCookies"]);app.factory("$store",["$parse","$cookieStore",function(e,t){var s="undefined"==typeof window.localStorage?void 0:window.localStorage,o=!("undefined"==typeof s||"undefined"==typeof window.JSON),u={parseValue:function(e){var t;try{t=JSON.parse(e),"undefined"==typeof t&&(t=e),"true"==t&&(t=!0),"false"==t&&(t=!1),parseFloat(t)!=t||angular.isObject(t)||(t=parseFloat(t))}catch(s){t=e}return t}},i={set:function(e,i){if(!o)try{return t.set(e,i),i}catch(l){console.log("Local Storage not supported, make sure you have the $cookieStore supported.")}var n=JSON.stringify(i);return s.setItem(e,n),u.parseValue(n)},get:function(e){if(!o)try{return u.parseValue(t.get(e))}catch(i){return null}var l=s.getItem(e);return u.parseValue(l)},remove:function(e){if(!o)try{return t.remove(e),!0}catch(u){return!1}return s.removeItem(e),!0},bind:function(t,s,o){return o=o||"",i.get(s)||i.set(s,o),e(s).assign(t,i.get(s)),t.$watch(s,function(e){i.set(s,e)},!0),i.get(s)}};return i}]),app.factory("$authenticator",["$rootScope","$store",function(e,t){return e.vulpejs={userDetails:{}},{userDetails:function(){return e.vulpejs.userDetails=t.get("userDetails"),e.vulpejs.userDetails},loginSuccessfully:function(s){e.vulpejs.userDetails=s,t.set("userDetails",e.vulpejs.userDetails)},updateUserDetails:function(){t.set("userDetails",e.vulpejs.userDetails)},logoutSuccessfully:function(){this.userIsAuthenticated=!1,t.remove("userDetails"),t.remove("userIsAuthenticated"),application&&application.login&&application.login.arrays&&application.login.arrays.forEach(function(e){t.remove(e)})}}}]),app.factory("$messages",["$rootScope",function(e){return{type:"",message:"",addMessage:function(e,t){this.type=e,this.message=t,this.broadcastMessage()},addErrorMessage:function(e){this.type="danger",this.message=e,this.broadcastMessage()},addInfoMessage:function(e){this.type="info",this.message=e,this.broadcastMessage()},addWarningMessage:function(e){this.type="warning",this.message=e,this.broadcastMessage()},addSuccessMessage:function(e){this.type="success",this.message=e,this.broadcastMessage()},cleanAllMessages:function(){this.broadcastCleanMessages()},broadcastMessage:function(){e.$broadcast("messageBroadcast")},broadcastCleanMessages:function(){e.$broadcast("cleanMessagesBroadcast")}}}]),app.factory("VulpeJS",["$rootScope","$parse","$http","$authenticator","$messages","$dialogs","$timeout","i18n","$store","$cookieStore","$cookies","$sce","$window","$filter",function($rootScope,$parse,$http,$authenticator,$messages,$dialogs,$timeout,i18n,$store,$cookieStore,$cookies,$sce,$window,$filter){var nothing=function(){},empty=function(){return""},pagination=$cookies.pagination?JSON.parse($cookies.pagination):{items:15,history:5},vulpejs={$store:$store,$authenticator:$authenticator,$timeout:$timeout,$filter:$filter,$window:$window,$parse:$parse,broadcast:function(e){$rootScope.$broadcast(e)},parse:function(e){return $parse(e)},i18n:function(e){return i18n.__(e)},now:[],ever:[],message:{success:function(e){$messages.addSuccessMessage(e)},error:function(e){$messages.addErrorMessage(e)},info:function(e){$messages.addInfoMessage(e)},warning:function(e){$messages.addWarningMessage(e)},clean:function(){$messages.cleanAllMessages()}},dialog:{confirm:function(e){$dialogs.confirm(vulpejs.i18n("Confirmation"),vulpejs.i18n(e.message)).result.then(function(){vulpe.utils.tryExecute(e.callback)},function(){})}},http:{get:function(e){$http({url:e.url,params:e.params||{}}).success(function(t){e.callback.success?vulpe.utils.tryExecute(e.callback.success,t):vulpe.utils.tryExecute(e.callback,t)}).error(function(t,s,o,u){vulpe.utils.tryExecute(e.callback.error,{data:t,status:s,header:o,config:u})})},"delete":function(e){$http({url:e.url,method:"DELETE",params:e.params||{}}).success(function(t){e.callback.success?vulpe.utils.tryExecute(e.callback.success,t):vulpe.utils.tryExecute(e.callback,t)}).error(function(t,s,o,u){vulpe.utils.tryExecute(e.callback.error,{data:t,status:s,header:o,config:u})})},post:function(e){$http.post(e.url,e.data).success(function(t){vulpe.utils.tryExecute(e.callback.success,t)}).error(function(t,s,o,u){vulpe.utils.tryExecute(e.callback.error,{data:t,status:s,header:o,config:u})})},error:{handle:{}}},context:{},item:{},itemOld:{},items:[],itemHistory:{data:[],item:[],version:null},model:{item:{},messages:{validate:{save:{exists:"This record already exists."},remove:{exists:"This record is being used by another registry and can not be deleted."}}},populate:!1,cancelBefore:nothing,cancel:function(){var e=function(){vulpejs.model.cancelBefore(vulpejs),vulpejs.doDebug({type:"CANCEl-BEFORE",item:vulpejs.item}),vulpejs.act.clear.item(!1),vulpejs.model.cancelAfter(vulpejs),vulpejs.doDebug({type:"CANCEl-AFTER",item:vulpejs.item})};vulpejs.hasChanged()?vulpejs.dialog.confirm({message:"The changed data will be lost. Do you really want to continue?",callback:function(){e()}}):e()},cancelAfter:nothing,cloneBefore:nothing,clone:function(e){vulpejs.model.cloneBefore(vulpejs),vulpejs.doDebug({type:"CLONE-BEFORE",item:vulpejs.item}),vulpejs.item=vulpejs.copy(e),vulpejs.itemOld=vulpejs.copy(e),delete vulpejs.item._id,vulpejs.ui.showing=!0,vulpejs.act.clear.history(),vulpejs.model.cloneAfter(vulpejs),vulpejs.doDebug({type:"CLONE-AFTER",item:vulpejs.item}),vulpejs.act.load.properties(),$timeout(function(){vulpejs.ui.focus()},100)},cloneAfter:nothing,closeBefore:nothing,close:function(e){vulpejs.model.closeBefore(vulpejs),vulpejs.doDebug({type:"CLONE-BEFORE",item:vulpejs.item}),vulpejs.item=vulpejs.copy(e),delete vulpejs.item._id,vulpejs.ui.showing=!0,vulpejs.act.clear.history(),vulpejs.model.closeAfter(vulpejs),vulpejs.doDebug({type:"CLONE-AFTER",item:vulpejs.item}),vulpejs.act.load.properties(),$timeout(function(){vulpejs.ui.focus()},100)},closeAfter:nothing,createBefore:nothing,create:function(){var e=function(){vulpejs.model.createBefore(vulpejs),vulpejs.doDebug({type:"CREATE-BEFORE",item:vulpejs.item}),vulpejs.act.clear.item(!0),$timeout(function(){vulpejs.ui.focus()},100),vulpejs.model.createAfter(vulpejs),vulpejs.doDebug({type:"CREATE-AFTER",item:vulpejs.item})};Object.keys(vulpejs.item).length>0&&vulpejs.item._id&&vulpejs.hasChanged()?vulpejs.dialog.confirm({message:"The changed data will be lost. Do you really want to continue?",callback:function(){e()}}):e()},createAfter:nothing,filter:{status:""},findBefore:nothing,find:function(e){vulpejs.model.findBefore(vulpejs),vulpejs.doDebug({type:"FIND-BEFORE",item:vulpejs.item}),$http.get(vulpejs.url.get()+(vulpejs.model.populate?"/populate":"")+"/"+e).success(function(e){vulpejs.item=e.item,vulpejs.itemOld=vulpejs.copy(vulpejs.item),vulpejs.ui.showing=!vulpejs.ui.showing,vulpejs.itemHistory.data=e.history.items,0!==vulpejs.itemHistory.data.length&&(vulpejs.ui.pagination.history.totalPages=e.history.pageCount,angular.forEach(vulpejs.itemHistory.data,function(e){vulpejs.itemHistory.items.push(JSON.parse(e.content))})),vulpejs.model.findAfter(vulpejs),vulpejs.doDebug({type:"FIND-AFTER",item:vulpejs.item}),vulpejs.act.load.properties(),$timeout(function(){vulpejs.ui.focus()},100)})},findAfter:nothing,history:{copy:function(){var e=angular.isObject(vulpejs.itemHistory.version);if(vulpejs.ui.form.historySelected.$setValidity("historyNotSelected",e),e){var t=vulpejs.item.version;vulpejs.item=vulpejs.itemHistory.version,t&&(vulpejs.item.version=t),vulpejs.itemOld=vulpejs.copy(vulpejs.item)}},list:function(e){vulpejs.act.clear.history(),e||(e=1),$http.get(vulpejs.url.get()+"/history/"+vulpejs.item._id+"/page/"+e).success(function(e){vulpejs.itemHistory.data=e.items,0!==vulpejs.itemHistory.data.length&&(vulpejs.ui.pagination.history.totalPages=e.pageCount,angular.forEach(vulpejs.itemHistory.data,function(e){vulpejs.itemHistory.items.push(JSON.parse(e.content))}))})}},listBefore:nothing,list:function(e){e||(e=1,vulpejs.currentPage=0),vulpejs.model.listBefore(vulpejs),vulpejs.doDebug({type:"LIST-BEFORE",items:vulpejs.items});var t=vulpejs.model.search.filter(vulpejs);t+="/page/"+e,$http.get(vulpejs.url.get(vulpejs.url.list)+t).success(function(e){vulpejs.items=e.items,vulpejs.ui.pagination.totalPages=e.pageCount,vulpejs.ui.pagination.totalItems=e.pageCount*vulpejs.ui.pagination.size,vulpejs.model.listAfter(vulpejs),vulpejs.doDebug({type:"LIST-AFTER",items:vulpejs.items})})},listAfter:nothing,saveBefore:nothing,saveType:"",save:function(e){vulpejs.ui.form.$valid&&(e?vulpejs.model.saveType=e:(vulpejs.item._id&&(vulpejs.isUpdate=!0),vulpejs.isValid=!0,vulpejs.operation="SAVE",vulpejs.model.saveBefore(vulpejs),vulpejs.isValid&&(vulpejs.doDebug({type:"SAVE-BEFORE",item:vulpejs.item}),vulpejs.message.clean(),$http.post(vulpejs.url.get(),vulpejs.item).success(function(e){vulpejs.item=e.item,vulpejs.itemOld=e.item,vulpejs.model.saveType.length>0&&("NEW"===vulpejs.model.saveType?vulpejs.model.create():"CLOSE"===vulpejs.model.saveType&&(vulpejs.model.create(),vulpejs.ui.showing=!1),vulpejs.model.saveType=""),vulpejs.message.success("Record successfully saved!"),$timeout(function(){vulpejs.model.list(),vulpejs.ui.focus()},100),vulpejs.model.saveAfter(vulpejs),vulpejs.doDebug({type:"SAVE-AFTER",item:vulpejs.item}),vulpejs.act.load.properties()}).error(httpErrorHandler))))},saveAfter:nothing,search:{filter:function(e){return e.model.filter.status?"/status/"+e.model.filter.status:""},predicate:"",reverse:!0},statusBefore:nothing,status:function(e,t){vulpejs.operation="STATUS",vulpejs.message.clean(),vulpejs.model.statusBefore(vulpejs),$http.post(vulpejs.url.get()+"/status",{id:e,status:t}).success(function(){vulpejs.item._id&&(vulpejs.item.status=t),vulpejs.message.success("Status successfully changed!"),vulpejs.model.statusAfter(vulpejs),$timeout(function(){vulpejs.model.list($rootScope.currentPage+1),vulpejs.ui.focus()},100)}).error(httpErrorHandler)},statusAfter:nothing,removeBefore:function(e,t){t()},remove:function(e){vulpejs.operation="REMOVE";var t=function(){vulpejs.message.clean(),vulpejs.model.removeBefore(e,function(){$http({method:"DELETE",url:"/"+vulpejs.ui.name+"/"+e}).success(function(){vulpejs.act.clear.item(!1),vulpejs.model.list(),vulpejs.message.success("Record successfully deleted!"),vulpejs.model.removeAfter(vulpejs)}).error(httpErrorHandler)})};$dialogs.confirm(i18n.__("Confirmation"),i18n.__("Do you really want to delete?")).result.then(function(){t()},function(){})},removeAfter:nothing,validate:nothing},load:{arrays:[],properties:[]},act:{clear:{history:function(){vulpejs.itemHistory.data=[],vulpejs.itemHistory.items=[],vulpejs.itemHistory.version=null},item:function(e){vulpejs.item=vulpejs.copy(vulpejs.model.item),vulpejs.item=vulpejs.eval.properties(vulpejs.item),vulpejs.act.clear.history(),$timeout(function(){vulpejs.itemOld=vulpejs.copy(vulpejs.item)},100),vulpejs.ui.showing=e}},addJSONValue:function(e,t,s){var o=JSON.stringify(e);return o=o.substring(0,o.length-1)+', "'+t+'":"'+s+'"}',JSON.parse(e)},removeFromArray:function(e,t,s){var o=function(){vulpejs.message.clean(),vulpejs.item[e].splice(s,1)},u=vulpejs.item[e][s][t];u?$dialogs.confirm(i18n.__("Confirmation"),i18n.__("Do you really want to delete?")).result.then(function(){o()},function(){}):o()},addToArray:function(e,t){vulpejs.message.clean(),vulpejs.item[e].push(t)},load:{array:function(e){var t=e.from,s=e.to,o=e.label;$rootScope.vulpejs[s]=[],t=vulpejs.eval.expression(t),t.length>0&&$http.get(t).success(function(e){$rootScope.vulpejs[s]=e.items,o&&angular.forEach($rootScope.vulpejs[s],function(e){if(e.label="",angular.isString(o))e.label+=e[o];else{var t=[],s=" - ";angular.isArray(o)?t=o:angular.isObject(o)&&(t=o.properties,s=o.separator),t.forEach(function(t){e.label.length>0&&(e.label+=s),e.label+=e[t]})}})})},property:function(options){var from=options.from,to=options.to,when=options.when,fromParts=from.split("."),fromProperty=fromParts.pop();from=null;var toParts=to.split("."),toProperty=toParts.pop();if(to=null,fromParts.forEach(function(e){from=null===from?$rootScope.vulpejs[e]:from[e]}),toParts.forEach(function(e){to=null===to?$rootScope.vulpejs[e]:to[e]}),angular.isArray(from))for(var array=from,i=0;i<array.length;i++)if(from=array[i],eval(when)){to[toProperty]=from[fromProperty];break}},properties:function(){vulpejs.load.properties.length>0&&vulpejs.load.properties.forEach(function(e){vulpejs.act.load.property(e)})}}},eval:{expression:function(e){var t=e;if(/\{(.*)\}/.test(e)){var s=e.match(/\{(.*)\}/),o=s[1].split(":");t=t.replace(s[0],"");var u="";if(o.length>1)if(-1!==o[1].indexOf(".")){var i=o[1].split(".");u="store"===o[0]?$store.get(i[0])?$store.get(i[0])[i[1]]:"":$rootScope.vulpejs[i[0]]?$rootScope.vulpejs[i[0]][i[1]]:""}else u="store"===o[0]?$store.get(o[1])?$store.get(o[1]):"":$rootScope.vulpejs[o[1]]?$rootScope.vulpejs[o[1]]:"";else if(-1!==o[0].indexOf(".")){var i=o[0].split(".");u=$rootScope.vulpejs[i[0]][i[1]]}else u=$rootScope.vulpejs[o[0]];0===u.length?t="":t+=u}return t},properties:function(e){if(angular.isObject(e))for(var t in e)angular.isArray(e[t])?e[t].forEach(function(e){e=vulpejs.eval.properties(e)}):e[t]=angular.isObject(e[t])?vulpejs.eval.properties(e[t]):vulpejs.eval.expression(e[t]);return e}},init:nothing,doDebug:function(e){vulpejs.debug&&console.debug(e)},ui:{form:{},name:"",showing:!1,datepicker:function(e){e.preventDefault(),e.stopPropagation(),vulpejs.datepickerOpened=!vulpejs.datepickerOpened},hotkeys:nothing,tab:{selected:0,next:function(){vulpejs.ui.showing&&$($("li.ng-isolate-scope").get(vulpejs.ui.tab.selected+1)).find("a").trigger("click")},previous:function(){vulpejs.ui.showing&&$($("li.ng-isolate-scope").get(vulpejs.ui.tab.selected-1)).find("a").trigger("click")},focus:function(e){e&&e.length>0&&$timeout(function(){vulpejs.ui.focusTo(vulpejs.ui.name+"-"+e)},100)},hotkeys:function(){$(document).bind("keydown.left",function(){return vulpejs.ui.tab.previous(),!1}).bind("keydown.right",function(){return vulpejs.ui.tab.next(),!1})}},focus:nothing,focusTo:function(e){$(0!==e.indexOf("#")?"#"+e:e).focus()},inputFocus:function(e){var t="input[name='"+e+"']",s=$(t).filter(function(){return""==this.value});s.length>0?$(s.get(0)).focus():$(t).focus()},checkUncheckAll:function(e){$rootScope.selectAll=!$rootScope.selectAll,angular.forEach($rootScope[e],function(e){e.selected=$rootScope.selectAll})},on:{blur:function(){},click:function(){},change:function(e){var t=e.type;t&&"SELECT"===t&&("undefined"!=typeof vulpejs.item[e.name]?vulpejs[e.items].forEach(function(t){t[e.value]===vulpejs.item[e.name]&&(vulpejs[e.name]=t)}):delete vulpejs[e.name])},select:function(e){var t=e.type;t&&"TYPEAHEAD"===t&&(vulpejs.item[e.rootProperty]=e.$item[e.itemProperty])}},flow:{submitBefore:nothing,submitAfter:nothing,submit:function(e,t){var s=$parse(t);vulpejs.ui.flow.submitBefore(e,s),e.upload(),vulpejs.ui.flow.submitAfter(e,s)},successBefore:nothing,successAfter:nothing,success:function(e,t,s){var o=$parse(s);vulpejs.ui.flow.successBefore(e,t,o),$parse(s).assign($rootScope,window.location.origin+"/flow/download/"+t.uniqueIdentifier+"?"+Date.now()),vulpejs.ui.flow.successAfter(e,t,o)}},pagination:{size:pagination.items,totalPages:0,totalItems:0,history:{size:pagination.history,totalPages:0,totalItems:0,changeHandler:function(e){vulpejs.message.clean(),vulpejs.model.history.list(e),vulpejs.itemHistory.version=null}},changeHandler:function(e){vulpejs.message.clean(),vulpejs.model.list(e)}}},hasRoles:function(e){for(var t=$authenticator.userDetails(),s=0;s<e.length;s++){var o=e[s];if(-1!==t.roles.indexOf(o))return!0}return!1},equals:function(e,t,s){return e?e[t]===s:!1},on:{ready:function(e){$(document).ready(function(){vulpe.utils.tryExecute(e)})},change:function(){}},hasChanged:function(e,t){e||t||(e=vulpejs.item,t=vulpejs.itemOld);for(var s in e)if(t.hasOwnProperty(s)&&t[s]!==e[s])return!0;return!1},copy:function(e){return angular.copy(e)},trustSrc:function(e){return $sce.trustAsResourceUrl(e)},url:{context:vulpe.ng.rootContext,get:function(e){return e||(e=vulpejs.ui.name),vulpejs.url.context+(0===e.indexOf("/")?e:"/"+e)},list:""},query:{},params:{},redirect:function(e){vulpejs.$window.location=e}};if(vulpejs.debug=$cookieStore.get("debug")||vulpejs.debug,window.location.search){var search=window.location.search.substring(1),status=function(e){if(-1!==e.indexOf("status=")){var t=e.split("=");"status"===t[0]&&(vulpejs.model.filter.status=t[1])}};if(-1!==search.indexOf("&"))search.split("&").forEach(function(e){var t=e.split("=");vulpejs.query[t[0]]=t[1],status(e)});else{var parts=search.split("=");vulpejs.query[parts[0]]=parts[1],status(search)}}var service=function(e){e?(vulpejs.debug=e.debug||!1,vulpejs.ui.name=e.name,vulpejs.url.list=e.plural||e.name+"s",vulpejs.model.search.predicate=e.predicate||"",e.populate&&(vulpejs.model.populate=e.populate),e.focus&&(vulpejs.ui.focus=function(){if(angular.isFunction(e.focus))e.focus(vulpejs);else{var t="#"+e.name.replace(/\-/g,"")+"-";angular.isObject(e.focus)?$(t+(vulpejs.item._id?e.focus.edit:e.focus.new)).focus():$(t+e.focus).focus()}}),e.messages&&(vulpejs.model.messages=e.messages),vulpejs.ui.hotkeys=e.hotkeys||nothing,e.list&&(e.list.filter&&(vulpejs.model.search.filter=e.list.filter),vulpejs.model.listBefore=e.list.before||nothing,vulpejs.model.listAfter=e.list.after||nothing),vulpejs.model.item=e.model||{},e.actions&&(e.actions.focus&&(vulpejs.ui.focus=e.actions.focus),vulpejs.model.validate=e.actions.validate||nothing,vulpejs.model.createBefore=e.actions.createBefore||nothing,vulpejs.model.createAfter=e.actions.createAfter||nothing,vulpejs.model.cloneBefore=e.actions.cloneBefore||nothing,vulpejs.model.cloneAfter=e.actions.cloneAfter||nothing,vulpejs.model.findBefore=e.actions.findBefore||nothing,vulpejs.model.findAfter=e.actions.findAfter||nothing,vulpejs.model.saveBefore=e.actions.saveBefore||nothing,vulpejs.model.saveAfter=e.actions.saveAfter||nothing,vulpejs.model.statusBefore=e.actions.statusBefore||nothing,vulpejs.model.statusAfter=e.actions.statusAfter||nothing,e.actions.removeBefore&&(vulpejs.model.removeBefore=e.actions.removeBefore),vulpejs.model.removeAfter=e.actions.removeAfter||nothing,vulpejs.model.cancelBefore=e.actions.cancelBefore||nothing,vulpejs.model.cancelAfter=e.actions.cancelAfter||nothing),e.load&&(vulpejs.load.arrays=e.load.arrays||[],vulpejs.load.properties=e.load.properties||[]),e.error&&(vulpejs.http.error.handle=e.error.handle||nothing),vulpejs.init=e.init||nothing):vulpejs.debug=!1},httpErrorHandler=function(e,t,s,o){angular.isFunction($vulpejs.http.error.handle)?vulpejs.http.error.handle({operation:vulpejs.operation,data:e,status:t,header:s,config:o,vulpejs:vulpejs}):e.validate?e.validate.exists&&("SAVE"===vulpejs.operation?vulpejs.message.info(vulpejs.model.messages.validate.save.exists):"REMOVE"===vulpejs.operation&&vulpejs.message.info(vulpejs.model.messages.validate.remove.exists)):vulpejs.message.error("An error occurred in the execution.")};return service.prototype.init=function(e){return $authenticator.userDetails(),vulpejs.init(vulpejs),application.init&&vulpe.utils.tryExecute(application.init),e&&$(document).ready(function(){e.mainForm&&(vulpejs.ui.form=e.mainForm),e.multiSelectTranslation={selectAll:i18n.__("Select all"),selectNone:i18n.__("Select none"),reset:i18n.__("Reset"),search:i18n.__("Search"),nothingSelected:i18n.__("Nothing is selected")}}),vulpejs.ui.name&&(vulpejs.act.clear.item(!1),vulpejs.model.validate(),vulpejs.model.list(),vulpejs.load.arrays.length>0&&angular.forEach(vulpejs.load.arrays,function(e){vulpejs.act.load.array(e)}),vulpejs.ui.hotkeys(),vulpejs.ui.tab.hotkeys(),vulpejs.ui.focus()),$rootScope.vulpejs},service.prototype.store=$store,$rootScope.vulpejs=vulpejs,service}]);